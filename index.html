<html>
	<head>
		<title>LatLon.org — OSMers sandbox</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		 <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
		 <link rel="stylesheet" href="lib/leaflet.draw/leaflet.draw.css"/>
		 <link rel="stylesheet" href="lib/leaflet.measurecontrol/leaflet.measurecontrol.css"/>
		 <link rel="stylesheet" href="css/main.css" />
		 <link rel="stylesheet" href="lib/Leaflet.FileLayer/Font-Awesome/css/font-awesome.min.css" />
	</head>
	<body>
		<div id="wrapper">
		<div id="header">
			<img src="images/cat.png"/>
			<form id="gpxForm">
				<label for="gpxURL">Загрузить трек с URL:</label>
				<input type="text" id="gpxURL" name="gpxURL"/>
				<input type="submit" value="Загрузить"/>
			</form>
		</div>
		<div id="container">
		 <div id="map"></div>
		</div>
		</div>
		 <script src="lib/jquery-2.1.4.min.js"></script>
		 <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
		 <script src="lib/leaflet.draw/leaflet.draw.js"></script>
		 <script src="lib/leaflet.measurecontrol/leaflet.measurecontrol.js"></script>
		 <script src="lib/leaflet-hash.js"></script>
		 <script src="lib/Leaflet.FileLayer/leaflet.filelayer.js"></script>
		 <script src="lib/Leaflet.FileLayer/togeojson/togeojson.js"></script>
		 <script src="lib/leaflet-omnivore.min.js"></script>

		 <script>

var params = {};
window.location.href.replace(/[?&]+([^=&]+)=([^&#]*)/gi, function(m, key, value) {
	params[key] = value;
});

var map = L.map('map').setView([53.90313, 27.56813], 7);

var latlon = L.tileLayer('http://tile.latlon.org/tiles/{z}/{x}/{y}.png', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
		'Tiles: <a href="https://github.com/jekhor/belroad">Belroad</a> style'
		});

var velo100 = L.tileLayer('http://tile.latlon.org/stranger/{z}/{x}/{y}.png', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
		'Tiles: <a href="http://чепецк.net/">чепецк.net</a> style'
		});

var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
		});

var genshtab = L.tileLayer.wms("http://ms.latlon.org/ms", {
	layers: 'GS-100k-N-34,GS-100k-N-35,GS-100k-N-36',
	format: 'image/png'
});

var genshtab_t = L.tileLayer("http://localhost:8080/tiles/gs/webmercator/{z}/{x}/{y}.png", {
	maxZoom: 13
});

var rkka50k = L.tileLayer('http://orda.of.by/.tiles/rkka/Z{z}/{y}/{x}.jpg', {
		maxZoom: 14,
		attribution: '<a href="http://orda.of.by/">orda.of.by</a>'
		});

var zis_vitebsk = L.tileLayer('http://vitebsk.gismap.by/ArcGIS/rest/services/WGS/Land_Vitebsk_public/MapServer/tile/{z}/{y}/{x}', {
		maxZoom: 18,
		minZoom: 15,
		attribution: '<a href="http://gismap.by/">Геопортал ЗИС</a>'
		});

var zis_minsk = L.tileLayer('http://gismap.by/arcgis/rest/services/Public/Land_Minsk_public/MapServer/tile/{z}/{y}/{x}', {
		minZoom: 14,
		maxZoom: 18,
		attribution: '<a href="http://gismap.by/">Геопортал ЗИС</a>'
		});

var lots_minsk = L.tileLayer('http://gismap.by/arcgis/rest/services/Public/Uchastki_Minsk_public/MapServer/tile/{z}/{y}/{x}', {
		minZoom: 14,
		maxZoom: 19,
		attribution: '<a href="http://gismap.by/">Геопортал ЗИС</a>'
		});

var baseLayers = {
	"LatLon": latlon,
	"чепецк.net": velo100,
	"OSM Mapnik": osm,
	"Генштаб, 1км": genshtab,
	"Генштаб, 1км (TMS)": genshtab_t,
	"РККА, 1:50000": rkka50k,
	"ЗИС Витебская обл.": zis_vitebsk,
	"ЗИС Минская обл.": zis_minsk
};

var overlays = {
	"Земельные участки, Минская обл.": lots_minsk
};

var layersCtl = L.control.layers(baseLayers, overlays).addTo(map);

var hashLayers = {
	'L': latlon,
	'C': velo100,
	'O': osm,
	'G': genshtab,
	'T': genshtab_t,
	'R': rkka50k,
	'V': zis_vitebsk,
	'M': zis_minsk,
	'U': lots_minsk
};

var control = L.Control.measureControl().addTo(map);

var hash = L.hash(map);
hash.formatHash = function(map, setLayer) {
	var center = map.getCenter(),
	zoom = map.getZoom(),
	precision = Math.max(0, Math.ceil(Math.log(zoom) / Math.LN2));

	var layers = "";
	for (l in hashLayers) {
		if (setLayer != undefined) {
			if (hashLayers[l] == setLayer)
				layers += l;
		} else {
			if (map.hasLayer(hashLayers[l]))
				layers += l;
		}
	}

	return "#" + [zoom,
	center.lat.toFixed(precision),
	center.lng.toFixed(precision)
	].join("/") + "?layers=" + layers;
};

if (params.layers) {
	var added = false;
	for (var i = 0; i < params.layers.length; i++) {
		if (hashLayers[params.layers[i]] != undefined) {
			hashLayers[params.layers[i]].addTo(map);
			added = true;
		}
	}
	if (!added)
		latlon.addTo(map);
} else {
	latlon.addTo(map);
}

function loadGpx(url) {

	if (!url)
		return;

	var proxyUrl = '/proxy.py';
	var gpxLayer = omnivore.gpx(proxyUrl + '?url=' + encodeURIComponent(url))
		.on('ready', function() {
			map.fitBounds(gpxLayer.getBounds());
		})
	.addTo(map);

};

if (params.gpxUrl) {
	loadGpx(decodeURIComponent(params.gpxUrl));
}

map.on('baselayerchange', function(e) {
	location.replace(hash.formatHash(map, e.layer));;
});


var style = { opacity: 0.5, color:'red' };

L.Control.FileLayerLoad.LABEL = '<i class="fa fa-folder-open"></i>';
var fileLayerCtl = L.Control.fileLayerLoad({
	// See http://leafletjs.com/reference.html#geojson-options
	layerOptions: {
		style: style,
		pointToLayer: function (data, latlng) {
			var layer =  L.circleMarker(latlng, {style: style});
			layer.bindPopup(data.properties.name);
			return layer;
		}
	},
	// Add to map after loading (default: true) ?
	addToMap: true,
	// File size limit in kb (default: 1024) ?
	fileSizeLimit: 16384,
	fitBounds: true,
	// Restrict accepted file formats (default: .geojson, .kml, and .gpx) ?
	formats: [
		'.gpx',
		'.geojson',
		'.kml'
	]
}).addTo(map);


fileLayerCtl.loader.on('data:loaded', function (e) {
	// Add to map layer switcher
	layersCtl.addOverlay(e.layer, e.filename);
});

$(document).ready(function() {
	$('#gpxForm').submit(function() {
		var gpxUrl = $('#gpxURL').val();

		loadGpx(gpxUrl);

		return false;
	});
});

		 </script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stat.komzpa.net/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//stat.komzpa.net/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

	</body>
</html>
